<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>æé†’æ¸…å–®</title>
  <link rel="stylesheet" href="/static/todo.css">
</head>
<body>
  <div class="form-box">
    <div class="user-info">
      ğŸ‘¤ {{ session['username'] }}
      <a href="{{ url_for('logout') }}" class="btn-logout">ç™»å‡º</a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="message-success" id="message">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="todo-header">
      <h2 class="todo-title">ğŸ“‹ æé†’æ¸…å–®</h2>
      <button type="button" class="btn-green" onclick="location.href='/todo/create'">
          ğŸ“ ï¼‹æ–°å¢
      </button>
    </div>

    <form method="POST" action="{{ url_for('todo_batch_delete') }}" onsubmit="return validateBatchDelete();">
      <button type="submit" class="btn-green btn-batch-delete mt-10 mb-10">ğŸ—‘ æ‰¹æ¬¡åˆªé™¤</button>
      <table id="todo-list" border="1" cellspacing="0" cellpadding="8">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>ç‹€æ…‹åˆ‡æ›</th>
            <th>æ¨™é¡Œ</th>
            <th>ç‹€æ…‹</th>
            <th>å„ªå…ˆé †åº</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for todo in todos %}
            <tr>
              <!-- å¤šé¸åˆªé™¤ checkbox -->
              <td>
                <input type="checkbox" name="selected_ids" value="{{ todo.id }}" class="select-item">
              </td>

              <!-- ä»»å‹™ç‹€æ…‹åˆ‡æ›æŒ‰éˆ• -->
              <td>
                <button type="button" class="btn-status-toggle" data-id="{{ todo.id }}">
                  {% if todo.is_done %}<span class="circle-check">âœ”</span>{% else %}â­•{% endif %}
                </button>
              </td>

              <!-- æ¨™é¡Œ -->
              <td>
                <strong {% if todo.is_done %}class="todo-done"{% endif %}>{{ todo.title }}</strong>
              </td>

              <!-- ç‹€æ…‹ -->
              <td>{{ "å·²å®Œæˆ" if todo.is_done else "æœªå®Œæˆ" }}</td>

              <!-- å„ªå…ˆé †åº -->
              <td>{{ todo.priority }}</td>

              <!-- æ“ä½œ -->
              <td>
                <a href="{{ url_for('todo_view', id=todo.id) }}">ğŸ‘ï¸ æŸ¥çœ‹</a>
                <a href="{{ url_for('todo_edit', id=todo.id) }}">âœï¸ ç·¨è¼¯</a>
                <a href="{{ url_for('todo_delete', id=todo.id) }}" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')">ğŸ—‘ åˆªé™¤</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    </form>
  </div>
  <script>
    const selectAll = document.getElementById("select-all");
    const checkboxes = document.querySelectorAll(".select-item");

    selectAll.addEventListener("change", function () {
      checkboxes.forEach(cb => cb.checked = this.checked);
    });

    checkboxes.forEach(cb => {
      cb.addEventListener("change", function () {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        selectAll.checked = allChecked;
      });
    });
    // æ‰¹æ¬¡åˆªé™¤é©—è­‰ï¼šè‡³å°‘é¸ä¸€é …
    function validateBatchDelete() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      if (!anyChecked) {
        alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„ä»»å‹™ï¼");
        return false;
      }
      return confirm("ç¢ºå®šè¦åˆªé™¤é¸å–çš„ä»»å‹™ï¼Ÿ");
    }
    document.querySelectorAll(".btn-status-toggle").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        fetch(`/todo/toggle_done/${id}`, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          }
        })
        .then(res => {
          if (res.ok) window.location.reload();
          else alert("ç‹€æ…‹åˆ‡æ›å¤±æ•—");
        });
      });
    });
  </script>
</body>
</html>