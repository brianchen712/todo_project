<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ 'ç·¨è¼¯' if todo and not readonly else 'æŸ¥çœ‹' if todo else 'æ–°å¢' }}æé†’äº‹é …</title>
  <link rel="stylesheet" href="/static/todo.css">
</head>
<body>
  <div class="form-box">
    <div class="user-info">
      ğŸ‘¤ {{ session['username'] }}
      <a href="{{ url_for('logout') }}" class="btn-logout">ç™»å‡º</a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="message-error">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="tabs">
      <div class="tab active" data-tab="basic">åŸºæœ¬è³‡æ–™</div>
      <div class="tab" data-tab="advanced">æ™‚ç¨‹èˆ‡æé†’</div>
    </div>

    <form method="POST" enctype="multipart/form-data">
      <input type="hidden" name="active_tab" id="active_tab" value="basic">

      <div id="basic" class="tab-content active">
        <label for="title">æ¨™é¡Œ <span style="color: red;">*</span></label>
        <input type="text" id="title" name="title" required
          {% if readonly %}readonly{% endif %}
          oninvalid="this.setCustomValidity('è«‹è¼¸å…¥æ¨™é¡Œ')"
          oninput="this.setCustomValidity('')"
          value="{{ todo.title if todo else '' }}">

        <label for="description">èªªæ˜ <span style="color: red;">*</span></label>
        <textarea id="description" name="description" required
          {% if readonly %}readonly{% endif %}
          oninvalid="this.setCustomValidity('è«‹è¼¸å…¥èªªæ˜')"
          oninput="this.setCustomValidity('')">{{ todo.description if todo else '' }}</textarea>

        <label for="priority">å„ªå…ˆé †åº <span style="color: red;">*</span></label>
        <select id="priority" name="priority" required
          {% if readonly %}disabled{% endif %}
          oninvalid="this.setCustomValidity('è«‹é¸æ“‡å„ªå…ˆé †åº')"
          oninput="this.setCustomValidity('')">
          {% for p in ['é«˜','ä¸­','ä½'] %}
            <option value="{{p}}" {% if todo and todo.priority == p %}selected{% endif %}>{{p}}</option>
          {% endfor %}
        </select>

        <label for="note">å‚™è¨»</label>
        <textarea id="note" name="note" {% if readonly %}readonly{% endif %}>{{ todo.note if todo else '' }}</textarea>

        {% if not readonly %}
        <div class="file-upload-group">
          <label>ä¸Šå‚³é™„ä»¶</label>
          <input type="file" id="attachment" name="attachment" style="display:none;">
          <button type="button" id="upload-trigger" class="btn-green">ï¼‹æ–°å¢</button>
          <span id="file-name" class="file-info"></span>
        </div>
        {% endif %}

        {% if todo and todo.attachment_filename %}
          <p class="file-info">ç›®å‰é™„ä»¶ï¼š
            <a href="{{ url_for('static', filename='uploads/' ~ todo.attachment_filename) }}" target="_blank">{{ todo.attachment_filename }}</a>
          </p>
        {% endif %}
      </div>

      <div id="advanced" class="tab-content">
        <label for="start_date">é–‹å§‹æ—¥æœŸ <span style="color: red;">*</span></label>
        <input type="date" id="start_date" name="start_date" required
          {% if readonly %}readonly{% endif %}
          value="{{ todo.start_date }}">

        <label for="end_date">çµæŸæ—¥æœŸ <span style="color: red;">*</span></label>
        <input type="date" id="end_date" name="end_date" required
          {% if readonly %}readonly{% endif %}
          value="{{ todo.end_date }}">

        <label for="repeat">é‡è¤‡è¨­å®š <span style="color: red;">*</span></label>
        <select id="repeat" name="repeat" required
          {% if readonly %}disabled{% endif %}
          oninvalid="this.setCustomValidity('è«‹é¸æ“‡é‡è¤‡é »ç‡')"
          oninput="this.setCustomValidity('')">
          {% for r in ['æ°¸ä¸','æ¯å°æ™‚','æ¯å¤©','å¹³æ—¥','å‘¨æœ«','æ¯å‘¨','æ¯å…©å‘¨','æ¯æœˆ','æ¯ä¸‰å€‹æœˆ','æ¯å…­å€‹æœˆ','æ¯å¹´'] %}
            <option value="{{r}}" {% if todo and todo.repeat == r %}selected{% endif %}>{{r}}</option>
          {% endfor %}
        </select>
      </div>

      {% if not readonly %}
      <div class="form-button-group button-bottom-space">
        <button type="submit" class="btn-green">å„²å­˜</button>
        <button type="button" class="btn-gray" onclick="window.location.href='/todo/list'">å–æ¶ˆ</button>
      </div>
      {% else %}
      <div class="form-button-group button-bottom-space">
        <button type="button" class="btn-gray" onclick="window.location.href='/todo/list'">è¿”å›åˆ—è¡¨</button>
      </div>
      {% endif %}
    </form>
  </div>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        document.getElementById('active_tab').value = tab.dataset.tab;
      });
    });

    window.addEventListener("DOMContentLoaded", function() {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get("tab");
      if (tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const selectedTab = document.querySelector(`[data-tab='${tab}']`);
        const selectedContent = document.getElementById(tab);
        if (selectedTab && selectedContent) {
          selectedTab.classList.add('active');
          selectedContent.classList.add('active');
          document.getElementById('active_tab').value = tab;
        }
      }
    });

    {% if not readonly %}
    document.getElementById("upload-trigger").addEventListener("click", function() {
      document.getElementById("attachment").click();
    });
    document.getElementById("attachment").addEventListener("change", function() {
      const file = this.files[0];
      if (file) {
        const allowed = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];
        const ext = file.name.split('.').pop().toLowerCase();
        if (!allowed.includes(ext)) {
          alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ pdf/doc/jpg/pngã€‚');
          this.value = '';
          document.getElementById("file-name").textContent = '';
        } else {
          document.getElementById("file-name").textContent = file.name;
        }
      }
    });
    {% endif %}
  </script>
</body>
</html>